### **2PC（两阶段提交）和3PC（三阶段提交）详解**

#### **1. 基本概念**

- **2PC（Two-Phase Commit）**：一种分布式事务协议，通过**准备阶段（Prepare）**和**提交阶段（Commit）**确保所有参与者要么全部提交事务，要么全部回滚。
- **3PC（Three-Phase Commit）**：2PC的改进版，新增**CanCommit阶段**，分为**CanCommit、PreCommit、DoCommit**三个阶段，降低阻塞风险。

------

#### **2. 2PC的执行流程**

1. 

   准备阶段（Prepare Phase）

   

   - 协调者询问参与者是否可以提交事务，参与者执行事务但不提交，记录Undo/Redo日志并反馈Yes/No。

2. 

   提交阶段（Commit Phase）

   

   - 若所有参与者反馈Yes，协调者发送Commit命令，参与者正式提交；否则发送Rollback命令回滚。

**问题**：

- **同步阻塞**：参与者需等待协调者指令，资源被长期占用。
- **单点故障**：协调者宕机会导致参与者阻塞。
- **数据不一致**：若部分参与者未收到Commit命令，系统状态不一致。

------

#### **3. 3PC的执行流程**

1. 

   CanCommit阶段

   

   - 协调者询问参与者是否**可能**提交事务（不锁定资源），参与者反馈Yes/No。

2. 

   PreCommit阶段

   

   - 若所有参与者反馈Yes，协调者发送PreCommit请求，参与者锁定资源并记录日志。

3. 

   DoCommit阶段

   

   - 协调者发送最终Commit/Rollback命令，参与者执行操作。

**改进点**：

- **超时机制**：参与者若未收到指令，超时后自动提交或回滚，减少阻塞。
- **降低单点故障影响**：PreCommit阶段后，参与者可自主决策。

**局限性**：

- 仍可能因网络分区导致数据不一致。

------

#### **4. 2PC vs 3PC对比**

| **特性**       | **2PC**                    | **3PC**                                   |
| -------------- | -------------------------- | ----------------------------------------- |
| **阶段数**     | 2阶段（Prepare + Commit）  | 3阶段（CanCommit + PreCommit + DoCommit） |
| **阻塞问题**   | 严重（参与者需等待协调者） | 缓解（超时机制）                          |
| **单点故障**   | 协调者宕机导致参与者阻塞   | 参与者可超时后自主决策                    |
| **数据一致性** | 可能不一致（部分Commit）   | 仍存在不一致风险                          |
| **适用场景**   | 强一致性要求不高的系统     | 需要更高可用性的系统                      |

------

#### **5. 实际应用**

- **2PC**：MySQL的XA事务、传统分布式数据库。
- **3PC**：较少直接使用，更多通过TCC或Paxos替代。

------

#### **总结**

- **2PC**：简单但存在阻塞和单点问题，适合低并发场景。
- **3PC**：通过增加阶段和超时机制优化2PC，但未彻底解决一致性问题。
- **现代方案**：Paxos、Raft等算法更常用于强一致性需求。