### **ZooKeeper 详解**

ZooKeeper 是一个**开源的分布式协调服务**，由雅虎开发，现为 Apache 项目，主要用于解决分布式系统中的**一致性、配置管理、命名服务、集群管理**等问题。它广泛应用于 Hadoop、Kafka、HBase、Dubbo 等分布式系统。

------

## **1. ZooKeeper 的核心功能**

ZooKeeper 提供以下核心功能：

1. 配置管理

   - 集中存储分布式系统的配置信息，所有节点监听配置变化，实现动态更新。

2. 命名服务

   ​	提供全局唯一的路径名称（如服务注册与发现）。

3. 分布式锁

   - 通过临时顺序节点实现互斥锁、读写锁。

4. 

   集群管理

   

   - 监控节点状态（临时节点自动删除机制），实现 Leader 选举。

5. 

   发布/订阅

   

   - 通过 Watcher 机制监听数据变更，实现事件驱动。

6. 

   队列管理

   

   - 支持 FIFO 队列和同步队列。

------

## **2. ZooKeeper 的架构**

### **2.1 集群角色**

ZooKeeper 集群由以下角色组成：

- Leader

  - 负责处理所有写请求，并通过 **ZAB 协议**（ZooKeeper Atomic Broadcast）同步数据。

- Follower

  - 处理读请求，参与 Leader 选举和写请求投票。

- Observer

  - 仅处理读请求，不参与选举，用于提高读性能。

### **2.2 数据模型**

ZooKeeper 采用**树形结构（ZNode Tree）**存储数据，类似于文件系统：

- ZNode

  （数据节点）

  - 每个 ZNode 可存储 

    ≤1MB

     数据，并包含以下属性：

    - `czxid`（创建事务ID）、`mzxid`（修改事务ID）、`version`（版本号）等。

- ZNode 类型

  - **持久节点（Persistent）**：手动删除才会消失。
  - **临时节点（Ephemeral）**：客户端会话结束自动删除（用于监控节点存活）。
  - **顺序节点（Sequential）**：自动追加递增序号（用于分布式锁）。

------

## **3. ZooKeeper 的核心机制**

### **3.1 ZAB 协议**

ZooKeeper 使用 **ZAB 协议**（类似 Raft）保证数据一致性：

1. Leader 选举

   - 集群启动或 Leader 宕机时，Follower 投票选出新 Leader。

2. 原子广播（Broadcast）

   - Leader 将写请求广播给 Follower，超过半数确认后提交。

3. 

   崩溃恢复

   

   - 宕机后通过日志（ZXID）恢复数据。

### **3.2 Watcher 机制**

- 客户端可对 ZNode 设置 **Watcher**，当数据变更时 ZooKeeper 会通知客户端。
- **一次性触发**：通知后需重新注册。

### **3.3 会话（Session）**

- 客户端与 ZooKeeper 建立 **TCP 长连接**，会话超时后临时节点会被删除。

------

## **4. ZooKeeper 的应用场景**

### **4.1 分布式锁**

通过 **临时顺序节点** 实现：

1. 客户端在 `/lock` 下创建临时顺序节点（如 `/lock/node_0001`）。
2. 检查自己是否是最小序号节点，若是则获得锁；否则监听前一个节点。
3. 释放锁时删除节点，或会话结束自动删除。

### **4.2 配置中心**

- 将配置存储在 `/config` 节点，所有服务监听该节点，变更时自动更新。

### **4.3 服务注册与发现**

- 服务提供者注册临时节点（如 `/services/service1`），消费者监听节点列表变化。

------

## **5. ZooKeeper 的优缺点**

### **5.1 优点**

- **强一致性**：ZAB 协议保证数据全局有序。
- **高可用**：半数以上节点存活即可提供服务。
- **轻量级**：数据存储在内存，响应快（读性能高）。

### **5.2 缺点**

- **不适合大数据存储**：单个 ZNode ≤1MB。
- **写性能较低**：需半数以上节点确认。
- **Watcher 不可靠**：一次性触发，可能丢失事件。

------

## **6. ZooKeeper vs KRaft**

- **ZooKeeper**：依赖 ZAB 协议，早期版本需 ZooKeeper 集群协调。
- **KRaft**：Kafka 3.0+ 内置的 Raft 协议，去 ZooKeeper 化，简化架构。

------

### **总结**

ZooKeeper 是分布式系统的“协调员”，通过 **ZAB 协议、Watcher 机制、临时节点** 等特性，实现配置管理、分布式锁、服务发现等功能。尽管新系统（如 Kafka KRaft）逐步替代其部分角色，ZooKeeper 仍是分布式协调的经典解决方案。