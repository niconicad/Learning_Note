**KRaft 协议**（Kafka Raft）是 Apache Kafka 引入的一种**分布式共识协议**，用于替代早期版本中依赖的 ZooKeeper，实现 Kafka 集群的**元数据管理和高可用性**。以下是核心要点：

------

### **1. KRaft 的核心设计**

- **基于 Raft 算法**：
   KRaft 采用 Raft 共识协议（一种强一致性算法），通过选举 Leader、日志复制和多数派确认机制，确保集群元数据的一致性。
- **去 ZooKeeper 化**：
   从 Kafka 2.8 开始实验性支持，3.0+ 版本逐步移除对 ZooKeeper 的依赖，将元数据管理内置于 Kafka 自身。

------

### **2. KRaft 的核心组件**

- 

  Controller 节点

  ：

  集群中部分 Broker 被选为 Controller，组成 Raft 集群，负责管理元数据（如 Topic、分区、副本信息）。

  - **Leader Controller**：处理元数据变更请求，写入日志并同步到 Follower。
  - **Follower Controller**：接收 Leader 的日志并持久化，参与选举和故障恢复。

- **元数据日志**：
   所有元数据变更以**顺序日志**形式存储，通过 Raft 协议保证一致性和持久化。

------

### **3. KRaft 的工作流程**

1. 

   Leader 选举

   ：

   - 当 Leader Controller 失效时，Follower 通过投票选举新 Leader（通常在 100ms 内完成）。

2. 

   日志复制

   ：

   - Leader 将元数据变更（如创建 Topic）写入本地日志，并复制到多数 Follower 节点。
   - 多数节点确认后，变更被提交并应用到集群状态。

3. 

   故障恢复

   ：

   - 节点宕机后，通过日志回放和状态机同步恢复数据一致性。

------

### **4. KRaft 的优势**

- **简化架构**：无需额外维护 ZooKeeper 集群，降低运维成本。
- **性能提升**：减少网络跳数，元数据操作延迟显著降低。
- **强一致性**：Raft 协议确保元数据变更的原子性和线性一致性。
- **扩展性**：支持更大规模的集群和分区数量。

------

### **5. 与 ZooKeeper 的对比**

| **特性**       | **ZooKeeper (ZAB 协议)**           | **KRaft (Raft 协议)**         |
| -------------- | ---------------------------------- | ----------------------------- |
| **依赖**       | 需独立部署 ZooKeeper 集群          | 集成在 Kafka 内部，无外部依赖 |
| **一致性**     | 强一致性，但选举期间可能短暂不可用 | 强一致性，选举更快（<100ms）  |
| **性能**       | 元数据操作受 ZooKeeper 瓶颈限制    | 直接内存处理，吞吐量更高      |
| **运维复杂度** | 需管理两套系统（Kafka + ZK）       | 仅需维护 Kafka 集群           |

------

### **6. 当前进展**

- **Kafka 3.3+**：KRaft 已成为默认模式，生产环境推荐使用。
- **未来计划**：完全移除 ZooKeeper 依赖，实现纯 KRaft 模式。

**总结**：KRaft 是 Kafka 实现**自包含元数据管理**的关键技术，通过 Raft 协议提供高可用、强一致性的集群协调能力，标志着 Kafka 向更轻量化、高性能架构的演进。