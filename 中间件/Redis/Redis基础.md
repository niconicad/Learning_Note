### **Redis 详细知识大全**

Redis（Remote Dictionary Server）是一个高性能的 **内存键值数据库**，支持多种数据结构，常用于缓存、消息队列、实时统计等场景。下面从 **基础概念、数据结构、持久化、集群、应用场景** 等方面详细介绍。

------

## **1. Redis 基础**

### **1.1 Redis 是什么？**

- **内存数据库**：数据主要存储在内存，读写速度极快（10万+ QPS）。
- **键值存储**：数据以 `key-value` 形式存储，支持多种数据结构。
- **单线程模型**：Redis 使用单线程处理命令，避免并发竞争，但通过 **IO 多路复用** 提高性能。
- **持久化支持**：数据可以持久化到磁盘，防止重启丢失。

### **1.2 Redis vs 传统数据库（MySQL）**

| **对比项**   | **Redis**                             | **MySQL**      |
| ------------ | ------------------------------------- | -------------- |
| **存储位置** | 内存                                  | 磁盘           |
| **数据结构** | String, Hash, List, Set, ZSet, Stream | 表（行+列）    |
| **性能**     | 10万+ QPS                             | 几千 QPS       |
| **持久化**   | 可配置（RDB/AOF）                     | 默认持久化     |
| **适用场景** | 缓存、高速读写、实时计算              | 事务、复杂查询 |

------

## **2. Redis 数据结构**

Redis 支持多种数据结构，每种结构适用于不同场景：

| **数据结构** | **存储形式**            | **常见用途**                   | **示例命令**                                                 |
| ------------ | ----------------------- | ------------------------------ | ------------------------------------------------------------ |
| **String**   | 简单键值对              | 缓存、计数器、分布式锁         | `SET name "Alice"`, `GET name`                               |
| **Hash**     | 字段-值映射（类似JSON） | 存储对象（用户信息、商品详情） | `HSET user:1 name Alice`, `HGET user:1 name`                 |
| **List**     | 双向链表                | 消息队列、最新消息列表         | `LPUSH news "latest"`, `RPOP news`                           |
| **Set**      | 无序唯一集合            | 标签、好友关系、去重           | `SADD tags "redis"`, `SMEMBERS tags`                         |
| **ZSet**     | 有序集合（带分数）      | 排行榜、优先级队列             | `ZADD rank 100 "Alice"`, `ZRANGE rank 0 5`                   |
| **Stream**   | 消息流（类似Kafka）     | 消息队列、事件日志             | `XADD orders * product_id 123`, `XREAD COUNT 10 STREAMS orders 0` |

------

## **3. Redis 持久化**

Redis 提供两种持久化方式，防止数据丢失：

### **3.1 RDB（Redis Database）**

- **原理**：定时生成内存快照（snapshot），保存到 `.rdb` 文件。

- 优点

  - 文件紧凑，恢复速度快。
  - 适合备份和灾难恢复。

- 缺点：

  - 可能丢失最近几分钟的数据（取决于备份频率）。

- 配置：

  bash

  复制

  ```bash
  save 900 1      # 15分钟内至少1个key变化就保存
  save 300 10     # 5分钟内至少10个key变化就保存
  ```

### **3.2 AOF（Append Only File）**

- **原理**：记录所有写操作命令（类似MySQL的binlog），重启时重放。

- 优点：

  - 数据更安全（最多丢失1秒数据）。
  - 支持 `fsync` 策略（`always`/`everysec`/`no`）。

- 缺点：

  - 文件较大，恢复较慢。

- 配置：

  bash

  复制

  ```bash
  appendonly yes         # 开启AOF
  appendfsync everysec   # 每秒同步一次
  ```

### **3.3 如何选择？**

- **高安全性**：AOF（`appendfsync always`）。
- **高性能**：RDB（适合缓存场景）。
- **混合模式**：RDB + AOF（Redis 4.0+ 支持）。

------

## **4. Redis 高可用与集群**

### **4.1 主从复制（Master-Slave）**

- **作用**：数据备份 + 读写分离。

- 原理：

  - 主节点（Master）处理写请求，从节点（Slave）同步数据。
  - 从节点可以接受读请求，分担主节点压力。

- 配置：

  bash

  复制

  ```bash
  # 在从节点执行
  replicaof <master-ip> <master-port>
  ```

### **4.2 Redis Sentinel（哨兵）**

- **作用**：监控主节点，自动故障转移（Failover）。

- 原理：

  - 哨兵集群监控主节点状态。
  - 主节点宕机时，选举新主节点。

- 配置：

  bash

  复制

  ```bash
  sentinel monitor mymaster 127.0.0.1 6379 2  # 监控主节点
  sentinel down-after-milliseconds mymaster 5000  # 5秒无响应判定宕机
  ```

### **4.3 Redis Cluster（集群）**

- **作用**：数据分片（Sharding）+ 高可用。

- 原理：

  - 数据分片到16384个槽（Slot），每个节点负责一部分槽。
  - 支持自动故障转移（主节点宕机，从节点接替）。

- 配置：

  bash

  复制

  ```bash
  # 启动集群（3主3从）
  redis-cli --cluster create 127.0.0.1:700{1..6} --cluster-replicas 1
  ```

------

## **5. Redis 应用场景**

| **场景**     | **适用数据结构**        | **示例**                            |
| ------------ | ----------------------- | ----------------------------------- |
| **缓存**     | String, Hash            | `SET user:1 "{name: Alice}"`        |
| **排行榜**   | ZSet                    | `ZADD leaderboard 100 "Alice"`      |
| **消息队列** | List, Stream            | `LPUSH tasks "task1"`, `RPOP tasks` |
| **分布式锁** | String（SETNX）         | `SET lock:order 1 NX EX 30`         |
| **去重统计** | Set                     | `SADD unique_visitors "user1"`      |
| **实时计算** | HyperLogLog（基数统计） | `PFADD ip_logs "192.168.1.1"`       |

------

## **6. Redis 常见问题**

### **6.1 缓存雪崩、击穿、穿透**

- **雪崩**：大量Key同时失效 → **随机过期时间**。
- **击穿**：热点Key失效 → **互斥锁**。
- **穿透**：查询不存在的数据 → **布隆过滤器**。

### **6.2 Redis 为什么快？**

1. **内存操作**（比磁盘快100倍）。
2. **单线程**（避免锁竞争）。
3. **IO 多路复用**（epoll/kqueue）。
4. **高效数据结构**（Hash表、跳表）。

### **6.3 Redis 适合存储大数据吗？**

- **适合**：高频访问的热数据（如缓存）。
- **不适合**：冷数据（占用内存成本高）。

------

## **总结**

- **Redis 是内存数据库**，适用于高速读写场景。
- **支持多种数据结构**（String, Hash, List, Set, ZSet, Stream）。
- **持久化方式**：RDB（快照） + AOF（日志）。
- **高可用方案**：主从复制、哨兵、集群。
- **典型应用**：缓存、排行榜、消息队列、分布式锁。

掌握这些知识，你已经可以应对大部分 Redis 面试题和实际开发需求！ 🚀